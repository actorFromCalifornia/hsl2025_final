services:
  foxglove-bridge:
    platform: linux/arm64/v8
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: hsl2025-foxglove
    profiles: ["foxglove"]
    command: >
      /bin/bash -lc "source /opt/ros/${ROS_DISTRO:-humble}/setup.bash && \
                     source /kobuki_ws/install/setup.bash && \
                     source /workspace/install/setup.bash && \
                     ros2 run foxglove_bridge foxglove_bridge --port 8765 --address 0.0.0.0"
    ports:
      - "8765:8765"
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-7}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_cyclonedds_cpp}

  bag_player:
    platform: linux/arm64/v8
    build:
      context: ..
      dockerfile: docker/Dockerfile
    profiles: ["bag"]
    command: >
      /bin/bash -lc "source /opt/ros/${ROS_DISTRO:-humble}/setup.bash && \
                     source /kobuki_ws/install/setup.bash && \
                     source /workspace/install/setup.bash && \
                     ros2 bag play \"${BAG_PATH:-/workspace/bags/rosbag2_2025_11_02-08_56_48}\" --clock --rate 1.0"
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-7}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_cyclonedds_cpp}
    volumes:
      - ../bags:/workspace/bags:ro
    depends_on:
      - foxglove-bridge

  kobuki-bringup:
    platform: linux/arm64/v8
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: hsl2025-kobuki
    privileged: true
    profiles: ["robot"]
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-7}
    network_mode: "host"
    volumes:
      - ../docker_ws:/workspace/docker_ws
      - /dev:/dev 
      - ../solution/workspace:/workspace
      - ../launch:/workspace/launch
      - ../docker:/workspace/docker
    command: >
      /bin/bash -lc "source /opt/ros/${ROS_DISTRO:-humble}/setup.bash && \
                     cd /workspace && colcon build && \
                     source /kobuki_ws/install/setup.bash && \
                     source /workspace/install/setup.bash && \
                     ros2 launch /workspace/launch/bringup.launch.py mode:=${BRINGUP_MODE:-bag}"
